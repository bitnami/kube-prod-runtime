
# Workflows

This document describes two different yet common workflows in BKPR using `kubeprod` and `kubecfg`:

* [Basic workflow](#basic-workflow)
* [Advanced workflow](#advanced-workflow)

These workflows are intended for users of BKPR, most likely developers, DevOps, Kubernetes operators, etc.

* The basic workflow covers those cases where the person using BKPR owns the Kubernetes cluster and has full privileges on it. This is usually the case for end-users who want to experiment with BKPR or developers working on a Kubernetes cluster on which they have full administrative privileges.
* The advanced workflow is intended for operators of production Kubernetes clusters which require greater customization and tuning that is not supported by the basic workflow.

## Pre-requisites

* [Kubernetes cluster](../readme.md#kubernetes-version-support-matrix)
* [`kubeprod`](https://github.com/bitnami/kube-prod-runtime/releases) binary
* [`kubecfg`](https://github.com/ksonnet/kubecfg/releases) binary

## Basic workflow

Use the basic workflow if you are:

* An end-user or developer with full administrative privileges to a Kubernetes cluster.
* An operator for a Kubernetes cluster that does not already have existing DNS and authentication infrastructure already in place.

The basic workflow is covered in the quickstart guides:

- [Quickstart: BKPR on Azure Kubernetes Service (AKS)](quickstart-aks.md)
- [Quickstart: BKPR on Google Kubernetes Engine (GKE)](quickstart-gke.md)

## Advanced workflow

The advanced workflow allows for greater control and customization than the basic workflow but involves several steps to get BKPR deployed to an existing Kubernetes cluster.

Use the advanced workflow if you are:

* An operator for a Kubernetes cluster that has existing DNS or authentication infrastructure already in place.
* Concerned with other cases where the basic workflow is not suitable.

We will use `kubeprod` and `kubecfg` to manage the BKPR lifecycle. `kubeprod` is part of BKPR and [`kubecfg`](https://github.com/ksonnet/kubecfg) is a tool for managing Kubernetes resources as code. `kubecfg` uses [jsonnet](https://jsonnet.org) to describe infrastructure based on templates. `kubeprod` is used to deploy BKPR into an existing Kubernetes cluster and `kubecfg` is used to show the differences between the running (live) configuration and the local configuration (e.g. your Git client).

### Check the default `kubectl` context

Ensure your default context in the Kubernetes `kubectl` client is the expected one:

```
$ kubectl config current-context
$ kubectl cluster-info
```

### Prepare the cluster

This step prepares the Kubernetes cluster and the underlying platform for deploying BKPR. This is accomplished by using `kubeprod install <platform>` where `<platform>` is the underlying platform for the Kubernetes cluster (e.g. AKS or GKE).

For example:

```
$ kubeprod install gke --only-generate \
                       --dns-zone ${dnsZone} \
                       --email ${email} \
                       --authz-domain ${authzDomain} \
                       --project ${gceProject} \
                       --oauth-client-id ${oauthClientId} \
                       --oauth-client-secret ${oauthClientSecret}
```

The `--only-generate` command-line flag tells `kubeprod` to configure the underlying platform (in this example, GKE) by creating the DNS zone if necessary, service accounts, etc. Afterwards, the root manifest and JSON configuration files are generated and `kubeprod` exits cleanly. At this point the operator can inspect the changes introduced by `kubeprod` and perform any customizations as explained next.

### Implement customizations (optional)

The root manifest file, `kubeprod-manifest.jsonnet`, generated by `kubeprod` is the place to implement any customizations desired for BKPR. For example, as described in [cert-manager](components.md#cert-manager) it is possible to use a different Let's Encrypt environment, in particular when testing BKPR.

For example, the `kubeprod-manifest.jsonnet` as created by `kubeprod` looks like this:

```
# Cluster-specific configuration
(import "manifests/platforms/gke.jsonnet") {
    config:: import "kubeprod-autogen.json",
    // Place your overrides here
}
```

If we evaluate the manifest using `kubecfg` and filter the output searching for the Let's Encrypt environment, we will find this:

```
$ kubecfg show kubeprod-manifest.jsonnet | grep -- --default-issuer-name
        - --default-issuer-name=letsencrypt-prod
```

To customize BKPR and use the Let's Encrypt staging environment, modify the `kubeprod-manifest.jsonnet` like this:

```
# Cluster-specific configuration
(import "manifests/platforms/gke.jsonnet") {
    config:: import "kubeprod-autogen.json",
    // Place your overrides here
    cert_manager+: {
        letsencrypt_environment:: "staging",
    }
}
```

The previous block of code does the following:

1. Imports the manifest at `manifests/platforms/gke.jsonnet` which describes how to deploy BKPR on GKE.
1. Under the `cert_manager` key (which implements the `cert-manager` component), overrides the `letsencrypt_environment` property to `staging` from its default value of `prod`.

To ensure the override is working as expected, let's evaluate the manifest again using `kubecfg` and filter the output searching for the Let's Encrypt environment. This time we will see that `cert-manager` will use the staging environment instead of the production environment:

```
$ kubecfg show kubeprod-manifest.jsonnet | grep -- --default-issuer-name
        - --default-issuer-name=letsencrypt-staging
```

Please refer to the [components](components.md) documentation for supported customizations in every component. Also refer to the [jsonnet](https://jsonnet.org) documentation.

### Test changes (only if BKPR is already deployed)

For example, to show the differences between the live state (what is currently running in the Kubernetes cluster) and the local configuration reflects, you can use `kubecfg diff` on the root manifest, like this:

```
$ kubecfg diff kubeprod-manifest.jsonnet
```

### Deploy changes

```
$ kubecfg update --ignore-unknown=true --gc-tag kube_prod_runtime kubeprod-manifest.jsonnet
```

NOTE: There is a [bug in kubecfg](https://github.com/ksonnet/kubecfg/issues/211) that always requires using `--ignore-unknown=true`, even if this command-line flag defaults to `true`.

### Check-in changes

For example,

```
$ git add kubeprod-manifest.jsonnet
$ git commit -m "Use Let's Encrypt staging environment"
```

Note that the **`kubeprod-autogen.json` file contains sensitive information**, like OAuth2 client and cookies secrets, or credentials for accessing the underlying platform's DNS services. If this information is inadvertently exposed, **it could compromise your Kubernetes cluster or any shared infrastructure**. As a best practice, we recommend explicitly ignoring kubeprod-autogen.json file in your source repository. Best practice is to explicitly ignore `kubeprod-autogen.json` file from your source.