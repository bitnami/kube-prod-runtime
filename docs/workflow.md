
# Workflows

Ths document documents two different yet common workflows in BKR using `kubeprod` and `kubecfg`:

* Basic workflow
* [Advanced workflow](#advanced-workflow)

## Pre-requisites

* An existing Kubernetes cluster.
* `kubeprod` binary from https://github.com/bitnami/kube-prod-runtime/releases

## Advanced workflow

1. Ensure the default `kubectl` context
1. Install BKPR into an existing Kubernetes cluster
1. Implement customizations (optional)
1. Test changes (only if BKPR is already deployed)
1. Deploy changes
1. Check-in changes

### Ensure the default `kubectl` context

Ensure your default context in the Kubernetes `kubectl` client is the expected one:

```
$ kubectl config current-context
gke_bkprtesting_europe-west1-b_felipe
```

and

```
$ kubectl cluster-info
Kubernetes master is running at https://35.240.18.142
GLBCDefaultBackend is running at https://35.240.18.142/api/v1/namespaces/kube-system/services/default-http-backend:http/proxy
Heapster is running at https://35.240.18.142/api/v1/namespaces/kube-system/services/heapster/proxy
KubeDNS is running at https://35.240.18.142/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://35.240.18.142/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

### Deploy BKPR into the Kubernetes cluster

For example,

```
$ kubeprod install gke --only-generate \
                       --dns-zone ${dnsZone} \
                       --email ${email} \
                       --authz-domain ${authzDomain} \
                       --project ${gceProject} \
                       --oauth-client-id ${oauthClientId} \
                       --oauth-client-secret ${oauthClientSecret}
```

The `--only-generate` command-line flag tells `kubeprod` to configure the underlying platform (in this example, GKE) by creating the DNS zone if necessary, service accounts, etc. Afterwards, the root manifest and JSON configuration files are generated and `kubeprod` exits cleanly. At this point the operator can inspect the changes introduced by `kubeprod` and perform any customisations as explained next.

### Implement customizations (optional)

The root manifest file, `kubeprod-manifest.jsonnet`, generated by `kubeprod` is the place where to implement any customisations desired for BKPR. For example, as described in [cert-manager](components.md#cert-manager) it is possible to use a different Let's Encrypt environment, in particular when testing BKPR.

For example, the `kubeprod-manifest.jsonnet` as created by `kubeprod` looks like this:

```
# Cluster-specific configuration
(import "manifests/platforms/gke.jsonnet") {
    config:: import "kubeprod-autogen.json",
    // Place your overrides here
}
```

If we evaluate the manifest using `kubecfg` and filter the output searching for the Let's Encrypt environment, we will find this:

```
$ kubecfg show kubeprod-manifest.jsonnet | grep -- --default-issuer-name
        - --default-issuer-name=letsencrypt-prod
```

To customise BKPR and use the Let's Encrypt staging environment, then `kubeprod-manifest.jsonnet` has to be modified like this:

```
# Cluster-specific configuration
(import "manifests/platforms/gke.jsonnet") {
    config:: import "kubeprod-autogen.json",
    // Place your overrides here
    cert_manager+: {
        letsencrypt_environment:: "staging",
    }
}
```

What the previous block of code does is the following:

1. Imports the manifest at `manifests/platforms/gke.jsonnet` which describes how to deploy BKPR on GKE.
1. Under the `cert_manager` key (which implements the `cert-manager` component), overrides the `letsencrypt_environment` property to `staging` from its default value of `prod`.

To ensure the override is working as expected let's evaluate the manifest again using `kubecfg` and filter the output searching for the Let's Encrypt environment. This time we will see that `cert-manager` will use the staging environment instead of the production environment:

```
$ kubecfg show kubeprod-manifest.jsonnet | grep -- --default-issuer-name
        - --default-issuer-name=letsencrypt-staging
```

Please refer to the [components](componens.md) documentation for supoorted customisations in every component and also feel free to read the BKPR source code. After all, that's one of the advatages of being open source.

### Test changes (only if BKPR is already deployed)

For example, to show the differences between the live state (what is currently running in the Kubernetes cluster) and the local (unpushed) configuration reflects, you can use `kubecfg diff` on the root manifest, like this:

```
$ kubecfg diff kubeprod-manifest.jsonnet
```

### Deploy changes

```
$ kubeprod install gke --dns-zone ${dnsZone} \
                       --email ${email} \
                       --authz-domain ${authzDomain} \
                       --project ${gceProject} \
                       --oauth-client-id ${oauthClientId} \
                       --oauth-client-secret ${oauthClientSecret}
```

### Check-in changes

For example,

```
$ git add kubeprod-manifest.jsonnet
$ git commit -m "Use Let's Encrypt staging environment"
```

Note that the `kubeprod-autogen.json` file contains sensitive information, like OAuth2 client and cookies secrets, or credentials for accessing the underlying platform's DNS services. Leaking or exposing this could lead to getting your Kubernetes cluster or any shared infrastructure compromised. Best practice is to explicitly ignore `kubeprod-autogen.json` file from your source 